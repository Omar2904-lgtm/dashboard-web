{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de An치lisis de Datasets</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* 游꿛 Estilos Minimalistas y Fondo Negro (Dark Mode Puro) 游꿛 */
        body {
            /* Fondo negro s칩lido para minimalismo y alto contraste */
            background-color: #000000;
            /* Texto principal en blanco o gris claro */
            color: #f8f9fa;
            min-height: 100vh;
        }
        
        /* Estilo para tarjetas: Fiel al minimalismo, sin blur o sombras excesivas */
        .card-custom {
            /* Fondo gris muy oscuro para destacar sobre el negro */
            background-color: #1a1a1a;
            /* Borde sutil */
            border: 1px solid #333333;
            border-radius: 8px; /* Borde m치s suave */
        }

        /* Estilo para los t칤tulos de las tarjetas */
        .card-title {
            color: #ffffff !important;
            border-bottom: 1px solid #333333; /* Separador sutil */
            padding-bottom: 10px;
        }

        /* Modificaci칩n de estilos de texto secundarios para mejor lectura */
        .text-secondary {
            color: #ffffff !important; /* Gris m치s claro para legibilidad */
        }
        
        /* Controles de formulario (para mantener la est칠tica dark mode) */
        .btn-minimal {
            /* Color principal, un contraste sutil como el gris oscuro */
            background-color: #333333; 
            border-color: #555555;
            color: #ffffff;
            transition: background-color 0.2s;
        }
        .btn-minimal:hover {
            background-color: #555555;
            border-color: #777777;
            color: #ffffff;
        }
        
        /* Bot칩n de an치lisis - Un color de acci칩n sobrio */
        .btn-analyze {
            background-color: #007bff; /* Azul cl치sico para acci칩n */
            border-color: #007bff;
            color: #ffffff;
        }
        .btn-analyze:hover {
            background-color: #0056b3;
            border-color: #0056b3;
            color: #ffffff;
        }

        /* Estilo para las alertas de recomendaci칩n (m치s discretas) */
        .bg-danger.bg-opacity-25, .bg-warning.bg-opacity-25, .bg-success.bg-opacity-25 {
            opacity: 1; /* Quitamos opacidad */
            /* Fondos discretos */
            background-color: #210000 !important; /* Rojo oscuro sutil */
            border: 1px solid #dc3545;
        }
        .bg-warning.bg-opacity-25 {
            background-color: #2b2100 !important; /* Amarillo oscuro sutil */
            border: 1px solid #ffc107;
        }
        .bg-success.bg-opacity-25 {
            background-color: #002100 !important; /* Verde oscuro sutil */
            border: 1px solid #198754;
        }

        /* Modificaci칩n del color del texto en Chart.js para un tema oscuro */
        .chartjs-render-monitor {
            color: #f8f9fa;
        }
        #recommendationsSection ul li {
            color: #ffffff !important;
        }
        
    </style>
</head>
<body>

    <div class="container my-5">
        <div class="text-center mb-5">
            <h1 class="text-white fw-bold">Pagina de An치lisis de Datasets</h1>
            <p class="text-secondary">Analiza la calidad de los datos encontradoa y toma decisiones informadas</p>
        </div>

        <div class="card card-custom p-4 mb-5">
            <div class="row justify-content-center">
                <div class="col-md-8 text-center">
                    <i data-lucide="upload" class="mb-3 text-info" style="width: 48px; height: 48px;"></i>
                    <form id="uploadForm">
                        <div class="mb-3">
                            <label for="csvFile" class="btn btn-lg btn-minimal">
                                Seleccionar CSV
                            </label>
                            <input type="file" id="csvFile" accept=".csv" class="d-none" required>
                        </div>
                        
                        <div id="fileInfo" class="text-center bg-dark p-3 rounded mb-3" style="display: none;">
                            <p class="text-white fw-bold" id="fileName"></p>
                            <p class="text-secondary small" id="fileSize"></p>
                        </div>

                        <button type="submit" id="analyzeBtn" class="btn btn-lg btn-analyze" disabled>
                            <i data-lucide="database" class="me-2" style="width: 20px; height: 20px;"></i>
                            Analizar Dataset
                        </button>
                        
                        <div id="loading" class="mt-3 text-center" style="display: none;">
                            <div class="spinner-border text-info" role="status"></div>
                            <div class="text-secondary small mt-2">Analizando... Esto puede tomar unos momentos</div>
                            </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div id="error" class="alert alert-danger" style="display: none;"></div>

        <div id="results" class="row g-4" style="display: none;">
            
            <div class="col-lg-4">
                <div class="card card-custom p-4 h-100">
                    <h3 class="card-title text-white mb-4"><i data-lucide="info" class="me-2"></i>Informaci칩n B치sica</h3>
                    <div class="d-flex justify-content-between mb-2"><span class="text-secondary">Filas:</span><span class="text-white fw-bold" id="infoRows"></span></div>
                    <div class="d-flex justify-content-between mb-2"><span class="text-secondary">Columnas:</span><span class="text-white fw-bold" id="infoCols"></span></div>
                    <div class="d-flex justify-content-between mb-2"><span class="text-secondary">Tama침o:</span><span class="text-white fw-bold" id="infoSize"></span></div>
                    
                    <h4 class="text-white mt-4 mb-3">Tipos de Datos</h4>
                    <div style="height: 250px;"><canvas id="dataTypeChart"></canvas></div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card card-custom p-4 h-100">
                    <h3 class="card-title text-white mb-4">M칠tricas de Calidad</h3>
                    <div id="qualityMetrics" class="mb-4">
                        </div>
                    <h4 class="text-white mt-4 mb-3">Distribuci칩n de Calidad</h4>
                    <div style="height: 250px;"><canvas id="qualityBarChart"></canvas></div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card card-custom p-4 h-100">
                    <h3 class="card-title text-white mb-4">Valores Faltantes</h3>
                    <div class="text-center mb-4">
                        <span class="text-danger fw-bold fs-4" id="missingTotal"></span>
                        <p class="text-secondary small">Total Missing Percentage</p>
                    </div>
                    <div style="height: 300px;"><canvas id="missingDataChart"></canvas></div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card card-custom p-4 h-100">
                    <h3 class="card-title text-white mb-4">Datos Duplicados</h3>
                    <div class="text-center mb-4">
                        <div class="text-warning fs-3 fw-bold" id="dupCount"></div>
                        <div class="text-secondary small" id="dupPerc"></div>
                    </div>
                    <h4 class="text-white mt-4 mb-3">Columnas Contribuyentes:</h4>
                    <div id="dupCols" class="small"></div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card card-custom p-4 h-100">
                    <h3 class="card-title text-white mb-4">Valores At칤picos</h3>
                    <div style="height: 300px;"><canvas id="outliersChart"></canvas></div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card card-custom p-4 h-100">
                    <h3 class="card-title text-white mb-4">Correlaciones Principales</h3>
                    <div style="height: 300px;"><canvas id="correlationChart"></canvas></div>
                </div>
            </div>

        </div>

        <div id="recommendationsSection" class="card card-custom p-4 mt-4" style="display: none;">
            <h3 class="card-title text-white mb-4">Recomendaciones de Tratamiento</h3>
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="bg-danger bg-opacity-25 rounded p-3 border border-danger"><h4 class="text-danger">Cr칤tico</h4><ul id="recCritical" class="list-unstyled small mt-2"></ul></div>
                </div>
                <div class="col-md-4">
                    <div class="bg-warning bg-opacity-25 rounded p-3 border border-warning"><h4 class="text-warning">Moderado</h4><ul id="recModerate" class="list-unstyled small mt-2"></ul></div>
                </div>
                <div class="col-md-4">
                    <div class="bg-success bg-opacity-25 rounded p-3 border border-success"><h4 class="text-success">Opcional</h4><ul id="recOptional" class="list-unstyled small mt-2"></ul></div>
                </div>
            </div>
        </div>

    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Inicializar Lucide Icons al cargar la p치gina
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            // Deshabilitar bot칩n de analizar hasta seleccionar archivo
            document.getElementById('analyzeBtn').disabled = true;
        });
    </script>
    <script>
        // --------------------------------------------------------------------------------
        // JS Vanilla para la L칩gica del Dashboard y Gr치ficos (Simulando Dashboard.js)
        // --------------------------------------------------------------------------------
        const form = document.getElementById('uploadForm');
        const fileInput = document.getElementById('csvFile');
        const fileInfoDiv = document.getElementById('fileInfo');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const resultsDiv = document.getElementById('results');
        const recommendationsSection = document.getElementById('recommendationsSection');
        const API_UPLOAD_ENDPOINT = "{{ api_upload_url }}"; 


        // Referencias de Chart.js
        let chartInstances = {};
        const CHART_COLORS = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6c757d', '#17a2b8']; // Colores m치s sobrios
        
        // --- 1. Manejo de Archivo Seleccionado ---
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                // Validaciones b치sicas
                if (!file.name.toLowerCase().endsWith('.csv') || file.size > 50 * 1024 * 1024) {
                    errorDiv.textContent = 'Archivo no v치lido (solo CSV < 50MB)';
                    errorDiv.style.display = 'block';
                    analyzeBtn.disabled = true;
                    fileInfoDiv.style.display = 'none';
                    return;
                }
                
                // Mostrar info del archivo
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileSize').textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB`;
                fileInfoDiv.style.display = 'block';
                errorDiv.style.display = 'none';
                analyzeBtn.disabled = false;
            }
        });
        

        // --- 2. Enviar para An치lisis ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const file = fileInput.files[0];
            if (!file) return;

            // Limpiar y mostrar carga
            errorDiv.style.display = 'none';
            resultsDiv.style.display = 'none';
            recommendationsSection.style.display = 'none';
            loadingDiv.style.display = 'block';
            analyzeBtn.disabled = true;

            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch(API_UPLOAD_ENDPOINT, { 
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': getCookie('csrftoken') } 
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Error al analizar el dataset');
                }

                displayDashboard(data.analysis);

            } catch (error) {
                errorDiv.textContent = 'Error: ' + error.message;
                errorDiv.style.display = 'block';
            } finally {
                loadingDiv.style.display = 'none';
                analyzeBtn.disabled = false;
            }
        });
        
        // --- 3. Renderizado de Gr치ficos y Datos ---

        function displayDashboard(analysis) {
            // Limpiar gr치ficos anteriores
            Object.values(chartInstances).forEach(chart => chart.destroy());
            
            // Renderizar la informaci칩n b치sica
            document.getElementById('infoRows').textContent = analysis.basic_info.total_rows.toLocaleString();
            document.getElementById('infoCols').textContent = analysis.basic_info.total_columns;
            document.getElementById('infoSize').textContent = analysis.basic_info.file_size;

            // Renderizar todos los gr치ficos
            renderDataTypeChart(analysis.basic_info.data_types);
            renderQualityBarChart(analysis.data_quality);
            renderMissingData(analysis.missing_data);
            renderDuplicates(analysis.duplicates);
            renderOutliers(analysis.outliers);
            renderCorrelation(analysis.correlation_matrix);
            renderRecommendations(analysis.recommendations);
            
            // Mostrar las secciones
            resultsDiv.style.display = 'flex';
            recommendationsSection.style.display = 'block';
            lucide.createIcons(); // Vuelve a inicializar iconos en el contenido nuevo
        }
        
        // Funci칩n auxiliar para obtener el CSRF token (Requerido por Django para POST)
        function getCookie(name) {
            // Implementaci칩n est치ndar de Django para obtener CSRF token
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // --- Funciones de Gr치ficos (Chart.js) ---

        // Configuraci칩n de opciones para el tema oscuro de Chart.js
        const DARK_CHART_OPTIONS = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                legend: { 
                    labels: { 
                        color: '#f8f9fa' // Color de texto de la leyenda
                    } 
                } 
            },
            scales: { 
                y: { 
                    ticks: { 
                        color: '#f8f9fa' // Color de texto del eje Y
                    }, 
                    grid: { 
                        color: 'rgba(255, 255, 255, 0.1)' // Color de las l칤neas de la cuadr칤cula
                    } 
                }, 
                x: { 
                    ticks: { 
                        color: '#f8f9fa' // Color de texto del eje X
                    }, 
                    grid: { 
                        display: false,
                        color: 'rgba(255, 255, 255, 0.1)' 
                    } 
                } 
            }
        };

        function renderDataTypeChart(dataTypes) {
            const labels = Object.keys(dataTypes);
            const data = Object.values(dataTypes);

            chartInstances.dataTypeChart = new Chart(document.getElementById('dataTypeChart'), {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: CHART_COLORS,
                    }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { legend: { labels: { color: '#f8f9fa' } } } 
                }
            });
        }
        
        function renderQualityBarChart(dataQuality) {
            const labels = Object.keys(dataQuality).map(key => key.charAt(0).toUpperCase() + key.slice(1).replace('_', ' '));
            const data = Object.values(dataQuality);

            // Inyectar m칠tricas de calidad
            const qualityHtml = labels.map((label, index) => `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="d-flex align-items-center">
                        <i data-lucide="${data[index] >= 90 ? 'check-circle' : 'alert-triangle'}" 
                            class="${data[index] >= 90 ? 'text-success' : 'text-warning'} me-2" style="width: 18px; height: 18px;"></i>
                        <span class="text-secondary">${label}</span>
                    </div>
                    <span class="fw-bold text-${data[index] >= 90 ? 'success' : data[index] >= 70 ? 'warning' : 'danger'}">
                        ${data[index].toFixed(1)}%
                    </span>
                </div>
            `).join('');
            document.getElementById('qualityMetrics').innerHTML = qualityHtml;
            
            chartInstances.qualityBarChart = new Chart(document.getElementById('qualityBarChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Puntuaci칩n (%)',
                        data: data,
                        backgroundColor: '#007bff', // Usamos el color principal de acci칩n
                    }]
                },
                options: { 
                    ...DARK_CHART_OPTIONS,
                    scales: { 
                        ...DARK_CHART_OPTIONS.scales,
                        y: { 
                            ...DARK_CHART_OPTIONS.scales.y,
                            beginAtZero: true, max: 100 
                        } 
                    }
                }
            });
        }
        
        function renderMissingData(missingData) {
            const labels = missingData.columns_with_missing.map(item => item.column);
            const data = missingData.columns_with_missing.map(item => item.percentage);
            
            document.getElementById('missingTotal').textContent = missingData.total_missing_percentage.toFixed(2) + '%';
            
            chartInstances.missingDataChart = new Chart(document.getElementById('missingDataChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Missing (%)',
                        data: data,
                        backgroundColor: '#dc3545', // Color peligro
                    }]
                },
                options: { 
                    ...DARK_CHART_OPTIONS,
                    indexAxis: 'y', // Bar horizontal
                    scales: { 
                        y: { 
                            ...DARK_CHART_OPTIONS.scales.y, 
                            grid: { color: 'rgba(255, 255, 255, 0.1)' } 
                        }, 
                        x: DARK_CHART_OPTIONS.scales.x 
                    } 
                }
            });
        }
        
        function renderDuplicates(duplicates) {
            document.getElementById('dupCount').textContent = duplicates.total_duplicates.toLocaleString();
            document.getElementById('dupPerc').textContent = `${duplicates.percentage}% del dataset`;
            
            // Usamos bg-secondary y text-white para el badge
            const colsHtml = duplicates.columns_contributing.map(col => 
                `<span class="badge bg-secondary text-white me-1">${col}</span>`
            ).join(' ');
            document.getElementById('dupCols').innerHTML = colsHtml || 'No hay columnas contribuyentes identificadas.';
        }

        function renderOutliers(outliers) {
            const labels = outliers.columns_with_outliers.map(item => item.column);
            const data = outliers.columns_with_outliers.map(item => item.outlier_count);
            
            chartInstances.outliersChart = new Chart(document.getElementById('outliersChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Conteo de Outliers',
                        data: data,
                        backgroundColor: '#ffc107', // Color advertencia
                    }]
                },
                options: { 
                    ...DARK_CHART_OPTIONS,
                    scales: { 
                        ...DARK_CHART_OPTIONS.scales,
                        y: { 
                            ...DARK_CHART_OPTIONS.scales.y,
                            beginAtZero: true 
                        }
                    }
                }
            });
        }

        function renderCorrelation(correlationMatrix) {
            const labels = correlationMatrix.map(item => `${item.var1} vs ${item.var2}`);
            const data = correlationMatrix.map(item => item.correlation);
            
            chartInstances.correlationChart = new Chart(document.getElementById('correlationChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Correlaci칩n',
                        data: data,
                        backgroundColor: '#17a2b8', // Color info
                    }]
                },
                options: { 
                    ...DARK_CHART_OPTIONS,
                    scales: { 
                        ...DARK_CHART_OPTIONS.scales,
                        y: { 
                            ...DARK_CHART_OPTIONS.scales.y,
                            beginAtZero: false 
                        } 
                    } 
                }
            });
        }
        
        function renderRecommendations(recommendations) {
            const renderList = (id, recs) => {
                const ul = document.getElementById(id);
                ul.innerHTML = recs.map(rec => `<li>&bull; ${rec.description}</li>`).join('');
            };
            
            renderList('recCritical', recommendations.critical || []);
            renderList('recModerate', recommendations.moderate || []);
            renderList('recOptional', recommendations.optional || []);
        }
        
    </script>
</body>
</html>